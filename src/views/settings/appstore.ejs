<%- include('../partials/head') %>

<div class="layout">
  <%- include('../partials/sidebar', { apps: [], currentApp: null }) %>

  <main class="main-content">
    <div class="page-header"><h1>Connect App Store</h1></div>
    <% if (success) { %><div class="alert alert-success"><%= success %></div><% } %>
    <% if (error) { %><div class="alert alert-error"><%= error %></div><% } %>

    <div class="section">
      <h2>Setup Instructions</h2>
      <div class="card">
        <div class="steps">
          <div class="step"><div class="step-number">1</div><div class="step-text">Go to <code>App Store Connect</code> &rarr; Users and Access &rarr; Keys</div></div>
          <div class="step"><div class="step-number">2</div><div class="step-text">Generate an API Key with <code>Admin</code> role</div></div>
          <div class="step"><div class="step-number">3</div><div class="step-text">Download the <code>.p8</code> file and open it in a text editor</div></div>
          <div class="step"><div class="step-number">4</div><div class="step-text">Note the <code>Key ID</code> and <code>Issuer ID</code> shown at the top of the Keys page</div></div>
        </div>
      </div>
    </div>

    <div class="section">
      <h2>Credentials</h2>
      <div class="card">
        <form method="POST" action="/dashboard/settings/appstore" id="credForm">
          <div class="form-group"><label>Issuer ID</label><input type="text" name="issuerId" value="<%= credential.credentials?.issuerId || '' %>" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" /></div>
          <div class="form-group"><label>Key ID</label><input type="text" name="keyId" value="<%= credential.credentials?.keyId || '' %>" placeholder="XXXXXXXXXX" /></div>
          <div class="form-group"><label>Private Key (.p8 content)</label><textarea name="privateKey" placeholder="-----BEGIN PRIVATE KEY-----&#10;...&#10;-----END PRIVATE KEY-----"><%= credential.credentials?.privateKey || '' %></textarea></div>
          <div style="display:flex;gap:12px;">
            <button type="button" class="btn btn-outline" onclick="testConnection()">Test Connection</button>
            <button type="submit" class="btn btn-neon">Save</button>
          </div>
        </form>
        <div id="testResult" class="test-result"></div>
      </div>
    </div>
  </main>
</div>

<script>
async function testConnection() {
  const form = document.getElementById('credForm');
  const data = Object.fromEntries(new FormData(form));
  const el = document.getElementById('testResult');
  el.className = 'test-result'; el.style.display = 'block'; el.textContent = 'Testing...';
  try {
    const res = await fetch('/dashboard/settings/appstore/test', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
    const result = await res.json();
    el.className = 'test-result ' + (result.success ? 'success' : 'error');
    el.textContent = result.message;
  } catch (e) { el.className = 'test-result error'; el.textContent = e.message; }
}
</script>
<%- include('../partials/footer') %>
